<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>NEO AI · next‑gen chat</title>
  <!-- Tailwind (lightweight CDN) + Font Awesome + Marked + Highlight.js -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <style>
    /* ===== NEXT‑GEN COLOR PALETTE ===== */
    :root {
      --neo-bg: #fafafa;           /* main background light */
      --neo-surface: #ffffff;       /* cards, input */
      --neo-sidebar: #0a0a0a;       /* black sidebar */
      --neo-sidebar-text: #f0f0f0;
      --neo-accent-orange: #f97316; /* orange-500 */
      --neo-accent-orange-dark: #ea580c;
      --neo-accent-green: #22c55e;  /* green-500 */
      --neo-accent-red: #ef4444;    /* red-500 */
      --neo-user-bubble: linear-gradient(145deg, #f97316, #f59e0b);
      --neo-ai-bubble: #1e1e1e;
      --neo-text-light: #ffffff;
      --neo-text-dark: #171717;
      --neo-border: #e5e5e5;
    }

    /* Dark mode overrides (class on body) */
    body.dark {
      --neo-bg: #121212;
      --neo-surface: #1f1f1f;
      --neo-sidebar: #000000;
      --neo-sidebar-text: #ededed;
      --neo-ai-bubble: #2a2a2a;
      --neo-text-dark: #f0f0f0;
      --neo-border: #2e2e2e;
    }

    body {
      background-color: var(--neo-bg);
      color: var(--neo-text-dark);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      transition: background-color 0.2s, color 0.2s;
    }

    /* Sidebar */
    .neo-sidebar {
      background-color: var(--neo-sidebar);
      color: var(--neo-sidebar-text);
      border-right: 1px solid var(--neo-border);
    }
    .neo-sidebar button, .neo-sidebar h1 {
      color: inherit;
    }
    .neo-sidebar .active-chat {
      background-color: rgba(249, 115, 22, 0.2); /* orange with transparency */
      border-left: 4px solid var(--neo-accent-orange);
    }

    /* Main header / input area */
    .neo-header, .neo-input-area {
      background-color: var(--neo-surface);
      border-color: var(--neo-border);
    }

    /* Message bubbles */
    .message-user {
      background: var(--neo-user-bubble);
      color: white;
      border-radius: 20px 20px 4px 20px;
    }
    .message-ai {
      background-color: var(--neo-ai-bubble);
      color: #f0f0f0;
      border-radius: 20px 20px 20px 4px;
      border-left: 3px solid var(--neo-accent-green);
    }

    /* Buttons */
    .btn-primary {
      background-color: var(--neo-accent-orange);
      color: white;
    }
    .btn-primary:hover {
      background-color: var(--neo-accent-orange-dark);
    }
    .btn-success {
      background-color: var(--neo-accent-green);
      color: white;
    }
    .btn-danger {
      background-color: var(--neo-accent-red);
      color: white;
    }

    /* Input field */
    .neo-input {
      background-color: var(--neo-surface);
      border: 1px solid var(--neo-border);
      color: var(--neo-text-dark);
    }
    .neo-input:focus {
      outline: none;
      border-color: var(--neo-accent-orange);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3);
    }

    /* Markdown / code blocks */
    .message-content pre {
      background-color: #2d2d2d !important;
      color: #f8f8f2;
      border-radius: 8px;
      padding: 0.75rem;
    }
    .dark .message-content pre {
      background-color: #1a1a1a !important;
    }

    /* Mobile sidebar animation (same as before) */
    @media (max-width: 768px) {
      .sidebar-mobile {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 75%;
        max-width: 280px;
        background: var(--neo-sidebar);
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        box-shadow: 4px 0 20px rgba(0,0,0,0.5);
      }
      .sidebar-mobile.open {
        transform: translateX(0);
      }
    }

    /* Typing cursor */
    .typing-cursor {
      display: inline-block;
      width: 0.5rem;
      height: 1.2rem;
      background-color: var(--neo-accent-green);
      animation: blink 1s infinite;
      margin-left: 2px;
      vertical-align: middle;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* Hide loading properly */
    #loading { z-index: 100; }
  </style>
</head>
<body class="antialiased">
  <!-- loading fallback (hidden by JS) -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-black z-50 text-xl" style="background: var(--neo-bg); color: var(--neo-accent-orange);">
    <i class="fas fa-spinner fa-pulse mr-2"></i> Loading NEO AI...
  </div>

  <!-- main app (hidden until JS loads) -->
  <div id="app" class="min-h-screen flex" style="display: none;">
    <!-- SIDEBAR (neo-sidebar) -->
    <aside id="sidebar" class="w-64 neo-sidebar flex flex-col sidebar-mobile md:relative md:translate-x-0">
      <div class="p-4 flex items-center justify-between border-b border-gray-800">
        <h1 class="font-bold text-lg flex items-center"><i class="fas fa-bolt mr-2 text-orange-500"></i>NEO AI</h1>
        <button id="newChatBtn" class="p-2 rounded hover:bg-orange-600 hover:text-white transition" title="New chat"><i class="fas fa-plus"></i></button>
      </div>
      <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1">
        <!-- dynamic chat items -->
      </div>
      <div class="p-4 border-t border-gray-800 space-y-1">
        <button id="settingsBtn" class="w-full text-left p-2 rounded hover:bg-orange-600 hover:text-white transition"><i class="fas fa-cog mr-2"></i>Settings</button>
        <button id="darkModeToggle" class="w-full text-left p-2 rounded hover:bg-orange-600 hover:text-white transition"><i class="fas fa-moon mr-2"></i>Dark mode</button>
      </div>
    </aside>

    <!-- MAIN PANEL -->
    <main class="flex-1 flex flex-col min-h-screen">
      <!-- mobile header with hamburger & system prompt -->
      <header class="neo-header border-b p-3 flex items-center md:hidden shadow-sm">
        <button id="menuToggle" class="mr-4 p-1"><i class="fas fa-bars text-2xl" style="color: var(--neo-accent-orange);"></i></button>
        <h2 class="font-semibold text-lg flex items-center"><i class="fas fa-bolt text-orange-500 mr-2"></i>NEO AI</h2>
        <button id="mobileSystemPromptBtn" class="ml-auto p-2" style="color: var(--neo-accent-orange);" title="System prompt"><i class="fas fa-edit"></i></button>
      </header>

      <!-- system prompt button for desktop (hidden on mobile) -->
      <div class="hidden md:flex justify-end p-3">
        <button id="desktopSystemBtn" class="btn-primary text-sm px-4 py-2 rounded-full shadow-md flex items-center">
          <i class="fas fa-edit mr-1"></i>System prompt
        </button>
      </div>

      <!-- messages container -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- messages appear here -->
      </div>

      <!-- input bar (always visible) -->
      <div class="neo-input-area border-t p-3 sticky bottom-0">
        <div class="flex items-end space-x-2 max-w-4xl mx-auto">
          <div class="flex-1 relative">
            <textarea id="userInput" rows="1" placeholder="Type a message..." class="neo-input w-full rounded-xl py-3 px-4 resize-none max-h-32"></textarea>
          </div>
          <button id="sendBtn" class="btn-primary rounded-full w-12 h-12 flex items-center justify-center shadow-md hover:scale-105 transition">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- SETTINGS MODAL (stylish) -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-900 rounded-xl w-full max-w-md p-6 shadow-2xl border-t-4 border-orange-500">
      <h3 class="text-lg font-bold mb-4 flex items-center"><i class="fas fa-cog mr-2 text-orange-500"></i>Settings</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
          <input type="password" id="apiKeyInput" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="sk-...">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Model</label>
          <input type="text" id="modelInput" placeholder="deepseek/deepseek-r1:free" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Default system prompt (new chats)</label>
          <textarea id="defaultSystemPromptInput" rows="3" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 dark:text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="You are a helpful assistant."></textarea>
        </div>
      </div>
      <div class="flex justify-end mt-6 space-x-2">
        <button id="closeSettingsBtn" class="px-4 py-2 border rounded-lg dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800">Cancel</button>
        <button id="saveSettingsBtn" class="btn-success px-4 py-2 rounded-lg">Save</button>
      </div>
    </div>
  </div>

  <!-- SYSTEM PROMPT MODAL (per chat) -->
  <div id="systemPromptModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-900 rounded-xl w-full max-w-md p-6 border-t-4 border-green-500">
      <h3 class="text-lg font-bold mb-4 flex items-center"><i class="fas fa-edit mr-2 text-green-500"></i>System prompt for this chat</h3>
      <textarea id="systemPromptInput" rows="5" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 dark:text-white focus:border-green-500 focus:ring-1 focus:ring-green-500"></textarea>
      <div class="flex justify-end mt-6 space-x-2">
        <button id="closeSystemPromptBtn" class="px-4 py-2 border rounded-lg dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800">Cancel</button>
        <button id="saveSystemPromptBtn" class="btn-success px-4 py-2 rounded-lg">Save</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      document.addEventListener('DOMContentLoaded', function() {
        // Hide loading, show app
        const loadingEl = document.getElementById('loading');
        const appEl = document.getElementById('app');
        if (loadingEl) loadingEl.style.display = 'none';
        if (appEl) appEl.style.display = 'flex';

        // ---------- GLOBAL STATE ----------
        let appState = {
          apiKey: localStorage.getItem('openrouter_api_key') || '',
          model: localStorage.getItem('openrouter_model') || 'deepseek/deepseek-r1:free',
          defaultSystemPrompt: localStorage.getItem('default_system_prompt') || 'You are a helpful assistant.',
          darkMode: localStorage.getItem('dark_mode') === 'true' ? true : false,
          chats: [],
          currentChatId: null,
          sidebarOpen: false,    // mobile
          isStreaming: false,
          abortController: null
        };

        // load chats from localStorage
        try {
          const saved = localStorage.getItem('chats');
          if (saved) {
            appState.chats = JSON.parse(saved);
          } else {
            // create a default welcome chat
            appState.chats = [{
              id: 'chat_' + Date.now(),
              name: 'Welcome',
              systemPrompt: appState.defaultSystemPrompt,
              messages: [{ role: 'assistant', content: 'Hello! How can I help you today?' }]
            }];
          }
          if (!appState.currentChatId && appState.chats.length > 0) {
            appState.currentChatId = appState.chats[0].id;
          }
        } catch (e) {
          console.warn('Failed to load chats', e);
          appState.chats = [];
        }

        // ---------- UTILITIES ----------
        function saveState() {
          localStorage.setItem('openrouter_api_key', appState.apiKey);
          localStorage.setItem('openrouter_model', appState.model);
          localStorage.setItem('default_system_prompt', appState.defaultSystemPrompt);
          localStorage.setItem('dark_mode', appState.darkMode);
          localStorage.setItem('chats', JSON.stringify(appState.chats));
        }

        function applyDarkMode() {
          if (appState.darkMode) {
            document.body.classList.add('dark');
          } else {
            document.body.classList.remove('dark');
          }
        }
        applyDarkMode();

        function currentChat() {
          return appState.chats.find(c => c.id === appState.currentChatId);
        }

        // ---------- RENDER SIDEBAR (with active class) ----------
        function renderSidebar() {
          const chatListEl = document.getElementById('chatList');
          if (!chatListEl) return;
          chatListEl.innerHTML = '';
          appState.chats.forEach(chat => {
            const isActive = chat.id === appState.currentChatId;
            const chatDiv = document.createElement('div');
            chatDiv.className = `flex items-center justify-between p-2 rounded-lg cursor-pointer ${isActive ? 'active-chat' : 'hover:bg-orange-800 hover:bg-opacity-30'}`;
            chatDiv.setAttribute('data-chat-id', chat.id);
            const nameSpan = document.createElement('span');
            nameSpan.className = 'truncate flex-1 text-sm font-medium';
            nameSpan.textContent = chat.name || 'Untitled';
            nameSpan.addEventListener('click', (e) => {
              e.stopPropagation();
              setCurrentChat(chat.id);
            });
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex space-x-1';
            const renameBtn = document.createElement('button');
            renameBtn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
            renameBtn.className = 'p-1 rounded hover:bg-orange-600 hover:text-white';
            renameBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              renameChat(chat.id);
            });
            const delBtn = document.createElement('button');
            delBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
            delBtn.className = 'p-1 rounded hover:bg-red-600 hover:text-white';
            delBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteChat(chat.id);
            });
            actionsDiv.appendChild(renameBtn);
            actionsDiv.appendChild(delBtn);
            chatDiv.appendChild(nameSpan);
            chatDiv.appendChild(actionsDiv);
            chatListEl.appendChild(chatDiv);
          });
        }

        // ---------- RENDER MESSAGES ----------
        function renderMessages() {
          const container = document.getElementById('messagesContainer');
          if (!container) return;
          const chat = currentChat();
          if (!chat) {
            container.innerHTML = '<div class="text-center text-gray-500 mt-10">No chat selected</div>';
            return;
          }
          container.innerHTML = '';
          chat.messages.forEach((msg) => {
            const msgDiv = createMessageElement(msg.content, msg.role);
            container.appendChild(msgDiv);
          });
          scrollToBottom();
        }

        function createMessageElement(text, role, isStreaming = false) {
          const div = document.createElement('div');
          div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
          const innerDiv = document.createElement('div');
          innerDiv.className = `max-w-[80%] md:max-w-[70%] rounded-2xl p-3 ${role === 'user' ? 'message-user' : 'message-ai'}`;
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content prose prose-sm dark:prose-invert max-w-none';
          if (role === 'assistant' && isStreaming) {
            contentDiv.innerHTML = marked.parse(text || '▌');
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            contentDiv.appendChild(cursor);
          } else {
            contentDiv.innerHTML = marked.parse(text || '');
          }
          contentDiv.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
          innerDiv.appendChild(contentDiv);
          div.appendChild(innerDiv);
          return div;
        }

        function scrollToBottom() {
          const container = document.getElementById('messagesContainer');
          if (container) container.scrollTop = container.scrollHeight;
        }

        // ---------- CHAT OPERATIONS ----------
        function setCurrentChat(chatId) {
          if (!chatId) return;
          appState.currentChatId = chatId;
          renderSidebar();
          renderMessages();
          if (window.innerWidth < 768) {
            appState.sidebarOpen = false;
            document.getElementById('sidebar')?.classList.remove('open');
          }
        }

        function newChat() {
          const newId = 'chat_' + Date.now();
          const newChatObj = {
            id: newId,
            name: 'New chat',
            systemPrompt: appState.defaultSystemPrompt,
            messages: [{ role: 'assistant', content: 'New chat started. How can I help?' }]
          };
          appState.chats.push(newChatObj);
          saveState();
          setCurrentChat(newId);
        }

        function deleteChat(chatId) {
          if (appState.chats.length <= 1) {
            alert('Cannot delete the last chat. Create a new one first.');
            return;
          }
          appState.chats = appState.chats.filter(c => c.id !== chatId);
          if (appState.currentChatId === chatId) {
            appState.currentChatId = appState.chats[0]?.id || null;
          }
          saveState();
          renderSidebar();
          renderMessages();
        }

        function renameChat(chatId) {
          const chat = appState.chats.find(c => c.id === chatId);
          if (!chat) return;
          const newName = prompt('Enter new chat name:', chat.name);
          if (newName && newName.trim()) {
            chat.name = newName.trim();
            saveState();
            renderSidebar();
          }
        }

        function editSystemPrompt() {
          const chat = currentChat();
          if (!chat) return;
          const modal = document.getElementById('systemPromptModal');
          const input = document.getElementById('systemPromptInput');
          input.value = chat.systemPrompt || '';
          modal.classList.remove('hidden');
        }

        // ---------- STREAMING / SEND MESSAGE ----------
        async function sendMessage() {
          const inputEl = document.getElementById('userInput');
          const text = inputEl.value.trim();
          if (!text || appState.isStreaming) return;

          const chat = currentChat();
          if (!chat) return;
          if (!appState.apiKey) {
            alert('Please set your OpenRouter API key in Settings');
            return;
          }

          if (appState.abortController) {
            appState.abortController.abort();
            appState.abortController = null;
          }

          chat.messages.push({ role: 'user', content: text });
          inputEl.value = '';
          renderMessages();

          const aiMessageIndex = chat.messages.length;
          chat.messages.push({ role: 'assistant', content: '' });
          renderMessages();

          appState.isStreaming = true;
          appState.abortController = new AbortController();
          const signal = appState.abortController.signal;

          const messages = [];
          if (chat.systemPrompt) {
            messages.push({ role: 'system', content: chat.systemPrompt });
          }
          const recentMessages = chat.messages.slice(-10).map(m => ({ role: m.role, content: m.content }));
          messages.push(...recentMessages);

          try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${appState.apiKey}`,
                'HTTP-Referer': window.location.origin,
                'X-Title': 'NEO AI Chat'
              },
              body: JSON.stringify({
                model: appState.model,
                messages: messages,
                stream: true
              }),
              signal
            });

            if (!response.ok) throw new Error(`HTTP error ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            let accumulated = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') continue;
                  try {
                    const parsed = JSON.parse(data);
                    const delta = parsed.choices?.[0]?.delta?.content || '';
                    accumulated += delta;
                    chat.messages[aiMessageIndex].content = accumulated;
                    renderMessages();
                  } catch (e) { console.warn('parse error', e); }
                }
              }
            }
          } catch (error) {
            if (error.name !== 'AbortError') {
              chat.messages[aiMessageIndex].content = '⚠️ Error: ' + error.message;
              renderMessages();
            }
          } finally {
            appState.isStreaming = false;
            appState.abortController = null;
            saveState();
            renderMessages();
          }
        }

        // ---------- MODALS ----------
        const settingsModal = document.getElementById('settingsModal');
        const systemModal = document.getElementById('systemPromptModal');

        document.getElementById('settingsBtn')?.addEventListener('click', () => {
          document.getElementById('apiKeyInput').value = appState.apiKey;
          document.getElementById('modelInput').value = appState.model;
          document.getElementById('defaultSystemPromptInput').value = appState.defaultSystemPrompt;
          settingsModal.classList.remove('hidden');
        });
        document.getElementById('closeSettingsBtn')?.addEventListener('click', () => {
          settingsModal.classList.add('hidden');
        });
        document.getElementById('saveSettingsBtn')?.addEventListener('click', () => {
          appState.apiKey = document.getElementById('apiKeyInput').value.trim();
          appState.model = document.getElementById('modelInput').value.trim() || 'deepseek/deepseek-r1:free';
          appState.defaultSystemPrompt = document.getElementById('defaultSystemPromptInput').value.trim() || 'You are a helpful assistant.';
          saveState();
          settingsModal.classList.add('hidden');
        });

        // system modal
        document.getElementById('mobileSystemPromptBtn')?.addEventListener('click', editSystemPrompt);
        document.getElementById('desktopSystemBtn')?.addEventListener('click', editSystemPrompt);
        document.getElementById('closeSystemPromptBtn')?.addEventListener('click', () => {
          systemModal.classList.add('hidden');
        });
        document.getElementById('saveSystemPromptBtn')?.addEventListener('click', () => {
          const chat = currentChat();
          if (chat) {
            chat.systemPrompt = document.getElementById('systemPromptInput').value;
            saveState();
          }
          systemModal.classList.add('hidden');
        });

        // ---------- EVENT LISTENERS ----------
        document.getElementById('newChatBtn')?.addEventListener('click', newChat);
        document.getElementById('darkModeToggle')?.addEventListener('click', () => {
          appState.darkMode = !appState.darkMode;
          applyDarkMode();
          saveState();
        });
        document.getElementById('menuToggle')?.addEventListener('click', () => {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('open');
          appState.sidebarOpen = sidebar.classList.contains('open');
        });
        document.getElementById('sendBtn')?.addEventListener('click', sendMessage);
        document.getElementById('userInput')?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // close sidebar if click outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth < 768 && appState.sidebarOpen) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('menuToggle');
            if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
              sidebar.classList.remove('open');
              appState.sidebarOpen = false;
            }
          }
        });

        // initial render
        renderSidebar();
        renderMessages();
        saveState();

        window.addEventListener('beforeunload', () => {
          if (appState.abortController) appState.abortController.abort();
        });
      });
    })();
  </script>
</body>
</html>